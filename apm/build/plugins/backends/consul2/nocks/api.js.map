{"version":3,"sources":["../../../../../src/plugins/backends/consul2/nocks/api.js"],"names":["Bluebird","promisifyAll","fs","upperFirst","s","charAt","toUpperCase","slice","getFileContent","fPath","fName","rawData","readFileAsync","path","join","fData","JSON","parse","split","kName","listName","name","map","ConsulAPI","host","port","__dirname","fileList","readdirAsync","pList","all","filter","f","indexOf","consulApi","reduce","acc","row","baseUri","get","times","reply","CatalogList1","AgentServiceList1","put","body","ID","Port","Checks","AgentServiceList2","AgentCheckList2","query","AgentCheckList3","note","kvPrefix","keys","cas","KvNodeBlockHeight","KvNodeBlockTime","KvCommitBlockValidator","KvProjectLevel","delete","recurse"],"mappings":"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","file":"api.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport Bluebird from 'bluebird';\nimport nock from 'nock';\n\nBluebird.promisifyAll(fs);\n\nconst upperFirst = (s) => s.charAt(0).toUpperCase() + s.slice(1);\n\n// Thanks Tan for this snippet\nconst getFileContent = (fPath) => async (fName) => {\n  const rawData = await fs.readFileAsync(path.join(fPath, fName));\n  const fData = JSON.parse(rawData);\n  const { 0: kName } = fName.split('.json');\n  const [, ...listName] = kName.split('_');\n  const name = listName.map(upperFirst).join('');\n  return { [name]: fData };\n};\n\n\nconst ConsulAPI = async (host, port) => {\n  const fPath = path.join(__dirname, '../', 'fixtures');\n  const fileList = await fs.readdirAsync(fPath);\n  const pList = await Promise.all(fileList.filter((f) => f.indexOf('.json') > -1)\n    .map(getFileContent(fPath)));\n  const consulApi = pList.reduce((acc, row) => ({ ...acc, ...row }), {});\n\n  const baseUri = `http://${host}:${port}`;\n  nock(baseUri).get('/v1/catalog/nodes').times(3).reply(200, consulApi.CatalogList1);\n  nock(baseUri).get('/v1/agent/services').reply(200, consulApi.AgentServiceList1);\n\n  nock(baseUri)\n    .put('/v1/agent/service/register', (body) => {\n      const {\n        ID,\n        Port,\n        Checks,\n      } = body;\n      if (typeof ID === 'undefined') return false;\n      if (typeof Port === 'undefined') return false;\n      if (typeof Checks === 'undefined') return false;\n      return true;\n    })\n    .reply(200, '');\n\n  nock(baseUri).get('/v1/agent/services').times(2).reply(200, consulApi.AgentServiceList2);\n  nock(baseUri).get('/v1/agent/checks').times(2).reply(200, consulApi.AgentCheckList2);\n  nock(baseUri)\n    .get('/v1/agent/checks')\n    .query({ filter: 'ServiceID == \"bcl-commit-hub\"' })\n    .reply(200, consulApi.AgentCheckList3);\n\n  nock(baseUri)\n    .put('/v1/agent/check/pass/service:bcl-commit-hub:3')\n    .query({ note: '1 missed blocks in last 100' })\n    .reply(200, '');\n\n  nock(baseUri)\n    .put('/v1/agent/check/warn/service:bcl-commit-hub:4')\n    .query({ note: 'Last block time is 40s behind current time' })\n    .reply(200, '');\n\n  nock(baseUri)\n    .put('/v1/agent/check/fail/service:bcl-commit-hub:5')\n    .query({ note: 'Peer count has dropped below 5' })\n    .reply(200, '');\n\n  const kvPrefix = '/v1/kv/projects/commit-hub/crust-2/';\n  nock(baseUri)\n    .get(`${kvPrefix}`)\n    .query({ keys: true })\n    .reply(404, '');\n\n  nock(baseUri)\n    .put(`${kvPrefix}nodes/ap-southeast-1/block-height`, (body) => {\n      if (body === JSON.stringify(100)) return true;\n      return false;\n    })\n    .query({ cas: 0 })\n    .reply(200, true);\n\n  nock(baseUri)\n    .get(`${kvPrefix}nodes/ap-southeast-1/block-height`)\n    .reply(200, consulApi.KvNodeBlockHeight);\n\n  nock(baseUri)\n    .get('/v1/kv/apm/settings/validator-addresses/bcl-commit-hub/unknown')\n    .reply(200, '');\n\n  nock(baseUri)\n    .put(`${kvPrefix}nodes/ap-southeast-1/block-time`, (body) => {\n      if (body === JSON.stringify(1566884093)) return true;\n      return false;\n    })\n    .query({ cas: 0 })\n    .reply(200, true);\n\n  nock(baseUri)\n    .get(`${kvPrefix}nodes/ap-southeast-1/block-time`)\n    .reply(200, consulApi.KvNodeBlockTime);\n\n  nock(baseUri)\n    .put(`${kvPrefix}commits/1000/swstest19`, (body) => {\n      if (body === JSON.stringify(true)) return true;\n      return false;\n    })\n    .query({ cas: 0 })\n    .reply(200, true);\n\n  nock(baseUri)\n    .get(`${kvPrefix}commits/1000/swstest19`)\n    .reply(200, consulApi.KvCommitBlockValidator);\n\n  nock(baseUri)\n    .get(`${kvPrefix}`)\n    .query({ keys: true })\n    .reply(200, consulApi.KvProjectLevel);\n\n  nock(baseUri)\n    .delete(`${kvPrefix}`)\n    .query({ recurse: true })\n    .reply(200, true);\n\n  nock(baseUri)\n    .put('/v1/agent/service/deregister/bcl-commit-hub')\n    .reply(200, '');\n};\n\nexport default ConsulAPI;\n"]}