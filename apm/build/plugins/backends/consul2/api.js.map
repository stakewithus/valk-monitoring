{"version":3,"sources":["../../../../src/plugins/backends/consul2/api.js"],"names":["logger","child","module","AgentServiceAPI","reqPartial","list","async","upsert","serviceDef","body","health","serviceId","destroy","AgentCheckAPI","listByFilter","f","qs","filter","register","check","checkId","ttlPass","note","ttlWarn","ttlFail","AgentAPI","service","CatalogAPI","KVAPI","keyPath","keys","get","getValue","response","length","rawData","Buffer","from","Value","toString","replace","e","value","keyOpts","kOpts","payload","del","txn","Api","nodeIP","nodePort","reqArgs","agent","catalog","kv","Backend","api"],"mappings":"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","file":"api.js","sourcesContent":["import pino from 'pino';\n\nimport rawRequest from '../../../common/http_client';\n\nconst logger = pino().child({ module: 'plugins/backends/consul' });\n\nconst AgentServiceAPI = (reqPartial) => {\n  const list = (async) => reqPartial('/v1/agent/services', 'GET')({ });\n\n  const upsert = async (serviceDef) => reqPartial('/v1/agent/service/register', 'PUT')({ body: serviceDef });\n\n  const health = async (serviceId) => reqPartial(`/v1/agent/health/service/id/${serviceId}`, 'GET')({});\n\n  const destroy = async (serviceId) => reqPartial(`/v1/agent/service/deregister/${serviceId}`, 'PUT')({ });\n  return {\n    list,\n    upsert,\n    health,\n    destroy,\n  };\n};\n\nconst AgentCheckAPI = (reqPartial) => {\n  const list = (async) => reqPartial('/v1/agent/checks', 'GET')({ });\n\n  const listByFilter = async (f) => reqPartial('/v1/agent/checks', 'GET')({ qs: { filter: f } });\n\n  const register = async (check) => reqPartial('/v1/agent/check/register', 'PUT')({ body: check });\n\n  const destroy = async (checkId) => reqPartial(`/v1/agent/check/deregister/${checkId}`, 'PUT')({ });\n\n  const ttlPass = async (checkId, note) => reqPartial(`/v1/agent/check/pass/${checkId}`, 'PUT')({ qs: { note } });\n\n  const ttlWarn = async (checkId, note) => reqPartial(`/v1/agent/check/warn/${checkId}`, 'PUT')({ qs: { note } });\n\n  const ttlFail = async (checkId, note) => reqPartial(`/v1/agent/check/fail/${checkId}`, 'PUT')({ qs: { note } });\n\n  return {\n    list,\n    listByFilter,\n    register,\n    destroy,\n    ttlPass,\n    ttlWarn,\n    ttlFail,\n  };\n};\n\nconst AgentAPI = (reqPartial) => ({\n  service: AgentServiceAPI(reqPartial),\n  check: AgentCheckAPI(reqPartial),\n});\n\nconst CatalogAPI = (reqPartial) => {\n  const list = (async) => reqPartial('/v1/catalog/nodes', 'GET')({});\n\n  return {\n    list,\n  };\n};\n\nconst KVAPI = (reqPartial) => {\n  const list = async (keyPath) => reqPartial(`/v1/kv/${keyPath}`, 'GET')({ qs: { keys: true } });\n\n  const get = async (keyPath) => reqPartial(`/v1/kv/${keyPath}`, 'GET')({ });\n\n  const getValue = async (keyPath) => {\n    try {\n      const response = await reqPartial(`/v1/kv/${keyPath}`, 'GET')({});\n      if (response && response.length > 0) {\n        const [rawData] = response;\n        return Buffer.from(rawData.Value, 'base64').toString('utf-8').replace(/\"/g, '').replace(/\\\\/g, '');\n      }\n      return null;\n    } catch (e) {\n      return null;\n    }\n  };\n\n  const upsert = async (keyPath, value, keyOpts) => {\n    const kOpts = {\n      ...keyOpts,\n    };\n    const payload = JSON.stringify(value);\n    return reqPartial(`/v1/kv/${keyPath}`, 'PUT')({ qs: kOpts, body: payload });\n  };\n\n  const del = async (keyPath, keyOpts) => {\n    const kOpts = {\n      ...keyOpts,\n    };\n    return reqPartial(`/v1/kv/${keyPath}`, 'DELETE')({ qs: kOpts });\n  };\n\n  const txn = async (value) => reqPartial('/v1/txn', 'PUT')({ body: value });\n\n  return {\n    list,\n    get,\n    getValue,\n    upsert,\n    del,\n    txn,\n  };\n};\n\nconst Api = (nodeIP, nodePort, reqArgs = {}) => {\n  const reqPartial = rawRequest(nodeIP, nodePort, reqArgs);\n  return {\n    agent: { ...AgentAPI(reqPartial) },\n    catalog: { ...CatalogAPI(reqPartial) },\n    kv: { ...KVAPI(reqPartial) },\n  };\n};\n\nconst Backend = (nodeIP = '127.0.0.1', nodePort = 8500, reqArgs = {}) => {\n  const api = Api(nodeIP, nodePort, reqArgs);\n  return {\n    Api: api,\n  };\n};\n\nexport default Backend;\n"]}